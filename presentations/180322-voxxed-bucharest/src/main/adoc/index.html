<!doctype html>
<!--[if IE 9]>
<html class="lt-ie10" lang="en"> <![endif]-->
<html class="no-js" lang="en" data-useragent="Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.2; Trident/6.0)">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blue-green Deployments and Canary Releases on Kubernetes</title>
    <meta name="description" content="Senior sustaining engineer at Red Hat Middleware, WildFly Camel, previously JBoss EAP, Hawkular and others.">
    <meta name="author" content="Your name goes here">
    <meta name="copyright" content="Maybe consider a Creative Commons license">
    <link rel="stylesheet" href="css/foundation.css">
    <link rel="stylesheet" href="css/font-awesome.css">
    <link rel="stylesheet" href="css/coderay.css">
    <link rel="stylesheet" href="css/asciidoctor.css">
    <script src="js/vendor/modernizr.js"></script>
    <script src="js/toc.js"></script>
</head>
<body>


<!-- Nav Bar -->

<nav class="top-bar" data-topbar>
    <ul class="title-area">
        <!-- Title Area -->
        <li class="name">
            <h1>
                <a href="">Home</a>
            </h1>
        </li>
        <li class="toggle-topbar menu-icon"><a href="#"><span>Menu</span></a></li>
    </ul>
</nav>
<!-- End Nav -->


<!-- Main Page Content and Sidebar -->

<div class="row">

    <!-- Main Blog Content -->
    <div class="large-9 columns" role="content">

        <div id="preamble">
<div class="sectionbody">
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-right valign-top">&#160;</th>
<th class="tableblock halign-left valign-top">&#160;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock">Peter Palaga&#160;&#160;&#160;&#160;</p>
<p class="tableblock"><a href="https://twitter.com/ppalaga">@ppalaga</a>&#160;&#160;&#160;&#160;&#160;&#160;&#160;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#160;&#160;&#160;&#160;&#160;&#160;Marek Jelen</p>
<p class="tableblock">&#160;&#160;&#160;&#160;<a href="https://twitter.com/marek_jelen">@marek_jelen</a></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="">&#160;</h2>
<div class="sectionbody">
<table id="slide1" class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><a href="https://twitter.com/ppalaga">Peter Palaga</a></th>
<th class="tableblock halign-left valign-top"><a href="https://twitter.com/marek_jelen">Marek Jelen</a></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Java guy"</p>
<p class="tableblock">JBoss Fuse, JBoss EAP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"Kubernetes &amp; OpenShift guy"</p>
<p class="tableblock">Developer Advocate</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="agenda">Agenda</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>A Spring Boot app</p>
</li>
<li>
<p>Bring it to the cloud</p>
</li>
<li>
<p>Deployment&#160;strategies</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="a_spring_boot_app">A Spring Boot app</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://github.com/ppalaga/horse-ride-service" class="bare">https://github.com/ppalaga/horse-ride-service</a></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Model with a few Entities</p>
</li>
<li>
<p>CRUD endpoints provided by Spring Data</p>
</li>
<li>
<p>Usual <code>@SpringBootTest</code></p>
</li>
</ul>
</div>
<div class="admonitionblock note speaker">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>Horse rides scheduling - Diesel engines forbidden soon, think of Uber for horses, Austrian ministry of Internal Affairs,</p>
</li>
<li>
<p>Usual Maven setup</p>
</li>
<li>
<p>Model with a couple of Entities</p>
</li>
<li>
<p>CRUD endpoints provided by Spring Data</p>
</li>
<li>
<p>One hand crafted endpoint for ride scheduling</p>
</li>
<li>
<p>Usual @SpringBootTest</p>
</li>
<li>
<p>So far developed only locally against a manually provisioned PostgreSQL database</p>
</li>
<li>
<p>A static index.html page we&#8217;ll use to demo some things</p>
</li>
<li>
<p>Nothing fancy here, it&#8217;s all just stock Spring Boot code</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>PP:
* The customer wants us not only to build the app, but also to run it
* The choice of platform and tools is up to us
* We want a process not only to build and test our app but also to deploy it in a controlled and predictable way
* We want to be able to do all those fancy things like Blue-green Deployments, Canary Releases and A/B Testing</p>
</div>
<div class="paragraph">
<p>MJ:
* Containers? Yes, because we like how the solve packaging incl. OS, configuration and provisioning
* Kubernetes standard these days, lets have a look at it
* Plain Kubernetes?
* Why OpenShift?
** &#8230;&#8203;</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="minishift_minikube">Minishift/Minikube</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Single node Kubernetes/OpenShift cluster</p>
</li>
<li>
<p>In a VM (hypervisor required)</p>
</li>
<li>
<p>Download and unzip from <a href="https://github.com/minishift/minishift/releases" class="bare">https://github.com/minishift/minishift/releases</a></p>
</li>
<li>
<p>Add <code>minishift</code> binary to <code>PATH</code></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="first_steps_with_minishift">First steps with Minishift</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell"><strong># You may need more or less CPU and memory</strong>
<strong># depending on what you do</strong>
minishift start --memory=8GB --cpus=4 --disk-size=50GB

oc login -u developer -p whatever

<strong># Open the OpenShift web console in browser</strong>
minishift console</code></pre>
</div>
</div>
<div class="admonitionblock note speaker">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>PP:
* The jungle of Kube objects looks pretty scary
* I&#8217;d expect to have to handcraft huge templates to construct the pipeline somehow&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>MJ:
* Not necessarily, depends on how much you want your pipeline to get polished
* Do you like Jenkins?
PP: Of course
MJ: Jenkins pipeline
PP: Groovy based DSL? - of course!
MJ: So just add a basic Jenkinsfile to your project and let&#8217;s see what happens
PP: I happen to have a Jenkinsfile there already
MJ: What&#8217;s in there?
PP: It is pretty minimal. It just issues the usual Maven build
MJ: It is skipping tests?
PP: Er&#8230;&#8203; yes, because I did not know how to provision a database
PP: BTW, who of you is using Jenkinsfiles?</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="jenkins_pipeline_on_openshift">Jenkins Pipeline on OpenShift</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell"><strong># make sure you are in the default project</strong>
<strong>$</strong> oc project
myproject
<strong>$</strong> oc new-app https://github.com/ppalaga/horse-ride-service.git</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>If the git repo contains a Jenkinsfile</p>
<div class="ulist">
<ul>
<li>
<p>Os creates a <code>BuildConfig</code> with a special <code>Pipeline</code> strategy</p>
</li>
<li>
<p>Provisions a Jenkins instance</p>
</li>
<li>
<p>Triggers the first build</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note speaker">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>PP: What? OpenShift provisions a Jenkins instance for me?
MJ: Yes, that&#8217;s one of those small diffs against plain Kube I mentioned earlier</p>
</div>
<div class="paragraph">
<p>oc delete project ride</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="preparations_for_a_real_pipeline">Preparations for a real pipeline</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Git repo inside the cluster</p>
</li>
<li>
<p>Separate projects for CI, stage and production</p>
</li>
<li>
<p>Some permissions for Jenkins</p>
</li>
<li>
<p>Done by <code>provision.sh</code> script:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">git clone https://github.com/ppalaga/horse-ride-service.git
cd horse-ride-service
git reset --hard provision.sh
oc login -u developer -p whatever
cd src/main/openshift; ./provision.sh</code></pre>
</div>
</div>
<div class="admonitionblock note speaker">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>MJ: private repo practical if you do not want to pay for private GitHub repos
* Also practical for us when on a flaky conf. WiFi
* Also important if your Kube/Os cluster is not accessible from the internet
PP: Yes, Github hooks would not work&#8230;&#8203;</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The last step calls  oc new-app with the internal git url</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="pipeline">Pipeline</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="build_and_test">Build and test</h3>
<div class="paragraph">
<p>Provision a database so that the <code>@SpringBootTest</code> can pass</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">cd horse-ride-service; git checkout master
git reset --hard testdb
git diff HEAD^ HEAD <strong># study what changed</strong>
<strong># Alias the cluster's internal git repo</strong>
URL=http://team:team@gogs-horse-ride-cicd.$(minishift ip).nip.io
git remote add minishift ${URL}/team/horse-ride-service.git
<strong># Push to the cluster's internal git repo</strong>
git push -f minishift master
<strong># Go to horse-ride-cicd project in OpenShift console</strong>
<strong># and check that the pipeline started under Builds > Pipelines</strong></code></pre>
</div>
</div>
<div class="admonitionblock note speaker">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>PP: in baseline, the tests were skipped
* Here, a database container is provisioned before running the mvn build
* What is this "openshift" object?
MJ: OpenShift Client Jenkins plugin
* It is available in the Os Jenkins image by default
PP: How about auth?
MJ: The client acts as user "jenkins"
PP: What can it do?
MJ: Most of usual things in the current project
* but if you want to do something in a project distict from the project where the Jenkinsfile is defined,
you have to grant some permissions to Jenkins manually
* That&#8217;s what we have done in provision.sh script
PP: env vars to pass the database info
PP: what if I do not want expose the password in the Jenkinsfile?
MJ: &#8230;&#8203;</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="build_and_test_docker_image">Build and test Docker image</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">git reset --hard test-image
git diff HEAD^ HEAD <strong># study what changed</strong>
git push -f minishift master
<strong># Look at horse-ride-cicd > Builds > Pipelines</strong>
<strong># Open the Jenkins log</strong></code></pre>
</div>
</div>
<div class="admonitionblock note speaker">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Jenkinsfile:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A new stage
PP: What is fabric8:build
MJ: A mvn plugin for building Docker images
PP: so I do not have to issue play with the docker command?
MJ: no, and it would be rather complicated inside the cluster
PP: Why?
MJ: Because the cluster does not expose the docker daemon to everyone
PP: Hm&#8230;&#8203; how are non-maven projects built then?
MJ: s2i &#8230;&#8203; and actually, the fabric8 plugin runs an s2i build under the hood
PP: interesting
PP: How do I tell the plugin what I want it to do?
MJ: look into pom.xml
PP: What is &lt;name&gt;%g/%a:test&lt;/name&gt; ?
MJ: name and tag to push to cluster-internal docker repo
PP: So there is a docker repo in the cluster?</p>
</li>
<li>
<p>That&#8217;s nice that I do not have to set it up myself
PP: &lt;assembly&gt; ?
MJ: That specifies what gets into the image. Just open the assembly.xml
PP: I like that this is using technologies I actaully know already
MJ: back to Jenkinsfile</p>
</li>
<li>
<p>Create a new app, but this time not out of a git repo, but out of the image tag we have just pushed using fabric8 plugin
PP: I see</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>PP: probe?
MJ: &#8230;&#8203;
PP: OK, it invokes the the /health endpoint provided by Spring Actuator</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="stage_approval_production">Stage &#8594; approval &#8594; production</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">git reset --hard stage-prod
git diff HEAD^ HEAD <strong># study what changed</strong>
git push -f minishift master
<strong># Look at horse-ride-cicd > Builds > Pipelines</strong>
<strong># Visit the stage and prod sites via links in Jenkins log</strong>
<strong># Approve the promotion from stage to production</strong></code></pre>
</div>
</div>
<div class="admonitionblock note speaker">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>Two new stages</p>
</li>
<li>
<p>Provision a database</p>
</li>
<li>
<p>Tag</p>
</li>
<li>
<p>Wait for rollout</p>
</li>
<li>
<p>Check the link, Approve</p>
</li>
<li>
<p>The same in prod: tag, rollout, link</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>PP: That&#8217;s straightforward: approve &#8594; production
* But let&#8217;s say I want to have a safe way back</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="blue_green_deployments">Blue/green deployments</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="images/blue-green.svg" alt="blue green">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Release in a predictable manner</p>
</li>
<li>
<p>Reduce downtime</p>
<div class="ulist">
<ul>
<li>
<p>Easy to switch to roll out a new version</p>
</li>
<li>
<p>Easy to roll back if the new version does not behave properly</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="https://martinfowler.com/bliki/BlueGreenDeployment.html" class="bare">https://martinfowler.com/bliki/BlueGreenDeployment.html</a></p>
</div>
<div class="admonitionblock note speaker">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>In Kube/Os:</p>
<div class="ulist">
<ul>
<li>
<p>One route, two services (and deployments)</p>
</li>
<li>
<p>The route switches based on spec.to.name: blue|green</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="blue_green_demo_1_2">Blue/green demo (1/2)</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">git reset --hard blue-green
git diff HEAD^ HEAD <strong># study what changed</strong>
git push -f minishift master
<strong># Look at horse-ride-cicd > Builds > Pipelines</strong>
<strong># The UI of new deployment should be blue</strong></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="blue_green_demo_2_2">Blue/green demo (2/2)</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">git reset --hard blue-green-green-bg
git diff HEAD^ HEAD <strong># study what changed</strong>
git push -f minishift master
<strong># Look at horse-ride-cicd > Builds > Pipelines</strong>
*# The UI of new deployment should be green</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="blue_green_caveats">Blue/green Caveats</h3>
<div class="ulist">
<ul>
<li>
<p>Long running sessions/connections need to be handled gracefully.</p>
<div class="imageblock right">
<div class="content">
<a class="image" href="http://www.oreilly.com/programming/free/migrating-to-microservice-databases.csp"><img src="images/migrating-to-microservice-databases.gif" alt="Migrating to Microservice Databases"></a>
</div>
</div>
</li>
<li>
<p>Database schema conversions</p>
<div class="ulist">
<ul>
<li>
<p>Ideally back/forwards compatible - see Edson Yanagas&#8217;s book</p>
</li>
<li>
<p>Downtime may be needed in some cases</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="canary_releases">Canary releases</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="images/canary.svg" alt="canary">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Roll out gradually</p>
</li>
<li>
<p>Observe canary&#8217;s health</p>
</li>
<li>
<p>Rollback if the canary dies</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="https://martinfowler.com/bliki/CanaryRelease.html" class="bare">https://martinfowler.com/bliki/CanaryRelease.html</a></p>
</div>
<div class="admonitionblock note speaker">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>Deployment strategy actually selectable for a DeploymentConfig</p>
<div class="ulist">
<ul>
<li>
<p>"Rolling" strategy is the default</p>
<div class="ulist">
<ul>
<li>
<p>provides a minimal canary</p>
</li>
<li>
<p>If readiness never succeeds, the new image is not rolled out
and the deployment actually fails after a few retries.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Is this enough? - No</p>
</div>
<div class="ulist">
<ul>
<li>
<p>"Recreate" - old code and new code do not run at once, but incurs downtime, supports pre, mid, post hooks to trigger any necessary migration steps</p>
</li>
<li>
<p>"Custom" - provide your own image that is run to perform the migration</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="canary_demo_1_2">Canary demo (1/2)</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">git reset --hard canary
git diff HEAD^ HEAD <strong># study what changed</strong>
git push -f minishift master
<strong># Observe the iterative checking of canary's health in Jenkins log</strong>
<strong># This canary survives and its UI background is yellow</strong></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="canary_demo_2_2">Canary demo (2/2)</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">git reset --hard canary-dead
git diff HEAD^ HEAD <strong># study what changed</strong>
git push -f minishift master
<strong># Observe the iterative checking of canary's health in Jenkins log</strong>
<strong># This canary dies and its gray UI won't be served after</strong>
<strong># the rollback</strong></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="wrap_up">Wrap up</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><code><a href="https://kubernetes.io/docs/tasks/tools/install-minikube/">minikube</a></code>/<code><a href="https://docs.openshift.org/latest/minishift/getting-started/installing.html">minishift</a></code> to start experimenting</p>
</li>
<li>
<p>Jenkins Pipeline a first class citizen on OpenShift</p>
</li>
<li>
<p><code><a href="https://jenkins.io/doc/book/pipeline/">Jenkinsfile</a></code> powerful enough to script your deployment strategy</p>
</li>
<li>
<p>Source of this demo: <a href="https://github.com/ppalaga/horse-ride-service" class="bare">https://github.com/ppalaga/horse-ride-service</a></p>
</li>
</ul>
</div>
</div>
</div>

    </div>

    <!-- End Main Content -->

    <!-- Sidebar

    <aside class="large-3 columns">

        <h4>Posts</h4>
        <ul id="posts" class="posts nav">
            
            <li><a href="./2017/10/04/first.html">First Entry</a></li>
            
        </ul>

        <div class="panel">
            <h5>Featured</h5>

            <p>Pork drumstick turkey fugiat. Tri-tip elit turducken pork chop in. Swine short ribs meatball irure bacon
                nulla pork belly cupidatat meatloaf cow.</p>
        </div>

    </aside>

    -->
    <!-- End Sidebar -->
</div>

<!-- End Main Content and Sidebar -->


<!-- Footer

<footer class="row">
    <div class="large-12 columns">
        <hr>
        <div class="row">
            <div class="large-12 columns">
                <p>Footer</p>
            </div>
        </div>
    </div>
</footer>
-->

<script src="js/vendor/jquery.js"></script>
<script src="js/foundation.min.js"></script>
<script>
$(document).foundation();
var doc = document.documentElement;
doc.setAttribute('data-useragent', navigator.userAgent);
</script>
</body>
</html>
